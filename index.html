<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Renju Lib Viewer</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <h2>Renju Lib Viewer</h2>

  <div class="controls">
    <div class="top-group">
      <input type="file" id="loadLib" accept="*/*" style="display: none;">
      <label for="loadLib" class="custom-file-upload">Load lib or db</label>
      <button id="btnNew" class="btn-new">New</button>
    </div>

    <div class="board-wrapper" id="capture-target">
      <div id="lib-info">Total Nodes: 0 | Current Move: 0</div>
      <div id="board-container">
        <canvas id="board" width="800" height="800"></canvas>
      </div>
      <div class="btn-group">
        <button id="btnUndo5">◀◀</button>
        <button id="btnUndo1">◀</button>
        <button id="btnRedo1">▶</button>
        <button id="btnRedo5">▶▶</button>
        <button id="btnText">Aa</button>
        <button id="btnPuzzle" title="Branch"><img src="./icons/branch.svg" alt="Branch"></button>
        <button id="btnShare" title="Share"><img src="./icons/share.svg" alt="Share"></button>
        <button id="btnSave" title="Save"><img src="./icons/file_save.svg" alt="Save"></button>
        <button id="btnDelete" title="Delete"><img src="./icons/delete.svg" alt="Del"></button>
        <button id="btnSettings" title="Settings"><img src="./icons/settings.svg" alt="Settings"></button>
        <button id="btnAbout" title="About"><img src="./icons/info.svg" alt="About"></button>
      </div>
    </div>

    <div id="comment-box" class="collapsed">
      <h3 id="comment-toggle">Comments <span class="toggle-arrow">▼</span></h3>
      <div class="comment-content">
        <textarea id="comment-text" placeholder="No Comments"></textarea>
      </div>
    </div>
  </div>

  <div class="input-group">
    <input type="text" class="status-bar" id="movesText" placeholder="h8h9..." spellcheck="false">
    <button class="copy-btn" id="btnCopyMoves">Copy</button>
  </div>
  <div class="input-group" style="margin-top: 5px;">
    <input type="text" class="status-bar" id="sgfText" placeholder="(;GM[1]SZ[15]...)" spellcheck="false">
    <button class="copy-btn" id="btnCopySgf">Copy</button>
  </div>
  <div id="toast">Copied Diagram.</div>

  <div id="aboutModal" class="modal hidden">
    <div class="modal-content">
      <span id="closeModal" class="close-btn">&times;</span>
      <h3>About This App</h3>
      <p>連珠(五目並べ)の棋譜閲覧アプリです。.lib形式のファイルを読み込んで棋譜を閲覧、またダウンロード、画面下部からテキストでの棋譜貼り付けに対応しています。</p>
      <hr>
      <p>製作者は連珠(五目並べ)関係のYouTubeチャンネルを運営しております。<br>応援していただけると嬉しいです。</p>
      <p><a href="https://www.youtube.com/channel/UCfbgN9hrrh9fmFKs8gxln5g" target="_blank">youtube(那智暴虐のれんじゅいし【競技五目並べ】)</a></p>
      <hr>
      <h4>License & Credits</h4>
      <p>Licensed under <a href="https://www.gnu.org/licenses/gpl-3.0.html" target="_blank">GPL v3.0</a>.</p>
      <p>This app is based on <strong>rapfi</strong> (GPL v3.0) by dhbloo. (About loading lib and db function.)</p>
      <p><a href="https://github.com/dhbloo/rapfi" target="_blank">Original Repository (GitHub)</a></p>
    </div>
  </div>

  <div id="encodingModal" class="modal hidden">
    <div class="modal-content">
      <h3>Select Encoding</h3>
      <p>ロード前にSettingから最大ノード数を設定してください。<br>ファイルの文字コードを選択してください。<br>(通常は Shift_JIS です)<br>
      Before you load lib please set max node in setting button and choose the character code.</p>
      <select id="modalEncodingSelect" style="width: 100%; margin: 10px 0;">
        <option value="shift-jis">Japanese (Shift_JIS)</option>
        <option value="gbk">Simplified Chinese (GBK/Simp)</option>
        <option value="big5">Traditional Chinese (Big5/Trad)</option>
        <option value="euc-kr">Korean (EUC-KR)</option>
        <option value="utf-8">UTF-8</option>
      </select>
      <div style="text-align: right; margin-top: 15px;">
        <button id="btnConfirmEncoding" style="max-width: none; padding: 10px 20px;">Load</button>
      </div>
    </div>
  </div>

  <div id="saveEncodingModal" class="modal hidden">
    <div class="modal-content">
      <h3>Save Configuration</h3>
      <p>保存形式と文字コードを選択してください。<br>※ブラウザで保存機能は使用できません。<br>※現状.dbの書き出しが機能しません。<br>Select File Format and Encoding.<br>*You can't save files from browser<br>*Currently saving by db format doesn't work.</p>

      <label style="display:block; font-weight:bold; margin-bottom:5px;">File Format:</label>
      <select id="modalSaveFormatSelect" style="width: 100%; margin-bottom: 15px; padding: 5px;">
        <option value="lib">RenLib (.lib)</option>
        <option value="db">YXDB (.db)</option>
      </select>

      <label style="display:block; font-weight:bold; margin-bottom:5px;">Encoding:</label>
      <select id="modalSaveEncodingSelect" style="width: 100%; margin-bottom: 15px; padding: 5px;">
        <option value="shift-jis">Japanese (Shift_JIS)</option>
        <option value="gb2312">Chinese (GB2312)</option>
        <option value="big5">Traditional Chinese (Big5)</option>
        <option value="utf-8">UTF-8</option>
        <option value="windows-1251">Cyrillic</option>
      </select>
      
      <div style="text-align: right; margin-top: 15px;">
        <button id="btnConfirmSaveEncoding" style="max-width: none; padding: 10px 20px;">Save</button><br>
        <button id="btnCancelSaveEncoding" style="max-width: none; padding: 10px 20px; background: #6c757d; margin-right: 5px;">Cancel</button>
      </div>
    </div>
  </div>

  <div id="loadingOverlay" class="modal hidden" style="z-index: 2000;">
    <div class="modal-content" style="text-align: center; padding: 30px;">
      <div class="spinner"></div>
      <h3 style="border:none; margin-top:15px;">Loading...</h3>
      <p id="loadingStatus" style="margin:0; font-family:monospace;">Processing nodes...</p>
    </div>
  </div>

  <div id="settingsModal" class="modal hidden">
    <div class="modal-content">
      <h3>Settings</h3>
      
      <label for="maxNodesInput" style="font-weight:bold; display:block; margin-bottom:5px;">Max Nodes (Memory Limit)</label>
      <p style="font-size:12px; color:#666; margin-top:0;">
        読み込む最大手数を設定します。<br>
        数値を上げるとメモリ不足でクラッシュする可能性があります。<br>
        (推奨: 3,000,000 〜 5,000,000)<br>
        Choose the maximum nodes you load.If max node is too high, the app might freeze or crash
      </p>
      <div style="margin-bottom: 10px;">
        <label style="font-size:12px; color:#444;">Presets:</label>
        <select id="maxNodesSelect" style="width: 100%; padding: 8px;">
          <option value="" disabled selected>Select a preset...</option>
          <option value="1000000">1,000,000 (Low Memory)</option>
          <option value="3000000">3,000,000 (Recommended)</option>
          <option value="5000000">5,000,000 (High Performance)</option>
          <option value="10000000">10,000,000 (Very High)</option>
        </select>
      </div>

      <div style="margin-bottom: 10px;">
        <label style="font-size:12px; color:#444;">Custom Value:</label>
        <input type="number" id="maxNodesInput" style="width: 100%; padding: 8px;" placeholder="Enter value...">
      </div>
<div style="margin-bottom: 15px;">
      <label style="display: flex; align-items: center; cursor: pointer;">
        <input type="checkbox" id="chkSaveSettings" style="margin-right: 8px;">
        <span style="font-size:14px;">Remember this setting (次回以降もこの設定を使用)</span>
      </label>
    </div>

      <div style="text-align: right; margin-top: 15px;">
        <button id="btnSaveSettings" style="max-width: none; padding: 10px 20px;">OK</button>
      </div>
    </div>
  </div>
  
  <script type="module" src="/main.js"></script>
  <script>
  let lastTouchEnd = 0;
  document.addEventListener('touchend', event => {
    const now = Date.now();
    if (now - lastTouchEnd <= 300) {
      event.preventDefault();
    }
    lastTouchEnd = now;
  }, false);
</script>
</body>
</html>